spring:
  cloud:
    gateway:
      server:
        webflux:
          routes:
            - id : itinerary-service
              uri: http://itinerary-service:8081
              predicates:
                - Path=/api/public/itinerary/**
              filters:
                - RewritePath=/api/public/itinerary/(?<segment>.*), /api/itinerary/v1/${segment}
                - name: RequestRateLimiter
                  args:
                    key-resolver: "#{@clientKeyResolver}"
                    redis-rate-limiter.burstCapacity: 5
                    redis-rate-limiter.replenishRate: 2
                    redis-rate-limiter.empty-key-status-code: 429
                    redis-rate-limiter.deny-empty-key: true
                    redis-rate-limiter.use-prefix: true
                - name: CircuitBreaker
                  args:
                    name : itineraryCircuitBreaker
                    fallbackUri: forward:/fallback/itinerary
            - id: booking-service
              uri: http://booking-service:8082
              predicates:
                - Path=/api/public/booking/**
              filters:
                - RewritePath=/api/public/booking/(?<segment>/.*)?, /api/booking/v1/${segment}
                - name: RequestRateLimiter
                  args:
                    key-resolver: "#{@clientKeyResolver}"
                    redis-rate-limiter.burstCapacity: 5
                    redis-rate-limiter.replenishRate: 1
                    redis-rate-limiter.empty-key-status-code: 429
                    redis-rate-limiter.deny-empty-key: true
                    redis-rate-limiter.use-prefix: true
                - name: CircuitBreaker
                  args:
                    name: bookingCircuitBreaker
                    fallbackUri: forward:/fallback/booking

  data:
    redis:
      host: redis
      port: 6379

resilience4j:
  circuitbreaker:
    instances:
      itineraryCircuitBreaker:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        automatic-transition-from-open-to-half-open-enabled: true
        permitted-number-of-calls-in-half-open-state: 2
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2s


      bookingCircuitBreaker:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        automatic-transition-from-open-to-half-open-enabled: true
        permitted-number-of-calls-in-half-open-state: 2
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2s

  timelimiter:
    instances:
      itineraryCircuitBreaker:
        timeout-duration: 5s
      bookingCircuitBreaker:
        timeout-duration: 5s



